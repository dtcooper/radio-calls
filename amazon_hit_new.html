<meta content="width=device-width,initial-scale=1" name="viewport">

<h1 class="container text-error bd-error" x-data="{show: true}" x-init="show = false" x-show="show">
  WARNING: Your web browser is <u>NOT</u> supported. Please use one of the following:
  <a href="https://www.google.com/chrome/" target="_blank">Google Chrome</a>,
  <a href="https://www.mozilla.org/en-US/firefox/" target="_blank">Mozilla Firefox</a>,
  or <a href="https://www.microsoft.com/en-us/edge" target="_blank">Microsoft Edge</a>
  to complete this assignment.
</h1>

<section x-data="radioCall()" x-init="init(); setStep(0)" class="container" x-cloak>
  <div id="volume-nav" class="grid text-center is-marginless is-paddingless" x-show="device !== null && connection !== null">
    <div class="row">
      <div class="col-2">Speaker Volume:</div>
      <div class="col-4 is-vertical-align">
        <progress class="is-full-width" x-bind:value="outputVolume.toString()" min="0" max="0.5"></progress>
      </div>
      <div class="col-2">Mic Volume:</div>
      <div class="col-4 is-vertical-align">
        <progress class="is-full-width" x-bind:value="inputVolume.toString()" min="0" max="0.5"></progress>
      </div>
    </div>
  </div>

  <div>
    <h1 id="step0" class="text-center"><u>Call a Live Radio Show and Talk About Poop</u></h1>

    <p>
      You will make a call in your web broswer to a radio show to tell the hosts
      about your <u>most recent poop</u>.
    </p>

    <p class="text-center">
      <button class="button primary" @click="setStep(1)">I have carefully read and understand the above!</button>
    </p>
  </div>

  <div x-show="step >= 1 || debug">
    <h2 id="step1">Step 1: Describe Your <u>Most Recent</u> Poop</h2>

    <blockquote>Select the type that most closely matches your <u><em>most recent poop</em></u> below (1 through 7).</blockquote>

    <table class="striped">
      <caption><strong>Bristol Stool Chart</strong></caption>
      <thead>
        <tr>
          <th>Select</th>
          <th>Type</th>
          <th>Diagram</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(poop, index) in poopTypes" :key="index">
          <tr>
            <td><button @click="poopType = index + 1; setStep(2)" class="button primary" x-text="`Select Type ${index + 1}`"></button></td>
            <td>
              <strong>
                <u x-text="`Type ${index + 1} &mdash; ${poop.name}`"></u>
              </strong>
            </td>
            <td>
              <span class="img">
                <img class="bd-light" x-bind:srcset="`${baseUrl}/static/images/poop-${index + 1}.jpg 2x`">
              </span>
            </td>
            <td class="text-italic" x-text="`${poop.description}.`"></td>
          </tr>
        </template>
      </tbody>
    </table>

    <p class="text-italic" x-show="poopType !== null">
      You selected <strong x-text="poopType !== null ? `Type ${poopType} &mdash; ${poopTypes[poopType - 1].name}` : 'unknown'"></strong>.
    </p>
  </div>

  <div x-show="step >= 2 || debug">
    <h2 id="step2">Step 2: Make the Call</h2>

    <blockquote>Click the button below to place the call in your browser. You will need to enable your microphone.</blockquote>

    <p class="text-center">
      <button @click="call" class="button success" x-bind:disabled="device === null || connection !== null">
        &#x1F4DE;&nbsp;&nbsp;Call&nbsp;&nbsp;&#x1F4DE;
      </button>
      <template x-if="debug">
        <button @click="hangUp" class="button error" x-bind:disabled="device === null || connection === null">
          Hang up (DEBUG only)
        </button>
      </template>
    </p>
  </div>

  <div x-show="step >= 3 || debug">
    <h2 id="step3">Step 3: Repeat the Word</h2>

    <blockquote>
      You will be called and the voice will say a word. Repeat it after the tone.<br>
      When you have successfully done this, click <em>Ready for Step 4</em> below.
    </blockquote>

    <p class="text-center">
      <button @click="setStep(4)" class="button primary" >Ready for Step 4</button>
    </p>

  </div>

  <div x-show="step >= 4 || debug">
    <h2 id="step4">Step 4: Enter the PIN Code</h2>

    <blockquote>You will be called and given a PIN code. Enter it below.</blockquote>

    PIN Code:
    <input id="pin-code" type="text" name="PinCode" x-model="pinCodeInput" pattern="\d*" maxlength="4">

    <p class="text-center">
      <button @click="verifyPinCode()" class="button primary" x-bind:disabled="pinVerified">Verify PIN Code</button>
    </p>

    <hr>
  </div>

  <div x-show="step >= 5 || debug">
    <h2 id="step5">Step 5: Talk About Your Poop</h2>

    <blockquote>You are being connected to a live radio show. Please tell the people on the show about your poop.</blockquote>
  </div>

    <!--
    <h2>Step 3: Talk About Your Poop</h2>

    <blockquote>Tell the people on the radio show about your poop.</blockquote>

    <p>
      <strong>Rules:</strong>
      <ul>
        <li><strong><u>You must speak in English</u></strong></li>
        <li>You must <strong><u>NOT</u></strong> mention Amazon Mechanical Turk</li>
        <li>Tell the people on the radio show about your poop. Use the diagram below and describe your most recent poop.</li>
      </ul>
    </p>
  </p>
  -->

  <div></div>
  <h2>Step 4: Submit the Assignment Below When Done</h2>

  <p class="text-center">
    <input id="submit" type="submit" value="Submit Assignment" disabled>
  </p>

  <template x-if="debug">
    <pre>
      step: <span x-text="JSON.stringify(step)"></span>
      poopType: <span x-text="JSON.stringify(poopType)"></span>
      inputVolume: <span x-text="JSON.stringify(inputVolume)"></span>
      outputVolume: <span x-text="JSON.stringify(outputVolume)"></span>
      pinCode: <span x-text="JSON.stringify(pinCode)"></span>
      pinCodeInput: <span x-text="JSON.stringify(pinCodeInput)"></span>
    </pre>
  </template>

</section>

<link crossorigin="anoymous" rel="stylesheet" href="https://unpkg.com/chota@0.8.0/dist/chota.min.css">
<style>
  :root {
    --font-family-sans: BlinkMacSystemFont, -apple-system, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    --font-size: 1.7rem;
    --color-primary: #007acc;
  }

  body {
    padding-bottom: 325px;
  }

  #volume-nav {
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 1;
  }

  h1, h2, h3, h4, h5, h6,
  button, input, .text-bold {
    font-weight: bold;
  }

  #pin-code {
    max-width: 350px;
  }

  [x-cloak] {
    display: none !important;
  }

  .text-italic {
    font-style: italic;
  }
</style>
<script src="https://media.twiliocdn.com/sdk/js/client/releases/1.14.0/twilio.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/gh/alpine-collective/alpine-magic-helpers@1.0.x/dist/scroll.min.js"></script>
<script>
  var baseUrl = 'https://radio-calls.containers.dtcooper.com/'
  var debug = true

  var poopTypes = [
  {name: 'Severe Constipation', description: 'Separate hard lumps, like nuts (hard to pass)'},
  {name: 'Mild Constipation', description: 'Sausage-shaped but lumpy'},
  {name: 'Normal', description: 'Like a sausage but with cracks on its surface'},
  {name: 'Normal', description: 'Like a sausage or snake, smooth and soft'},
  {name: 'Lacking Fiber', description: 'Soft blobs with clear-cut edges'},
  {name: 'Mild Diarrhea', description: 'Mushy consistency with ragged edges'},
  {name: 'Severe Diarrhea', description: 'Liquid consistency with no solid pieces'}
  ]

  function radioCall() {
    return {
      step: 0,
      poopType: null,
      device: null,
      connection: null,
      inputVolume: 0,
      outputVolume: 0,
      pinCode: '1234', // xxx should be null
      pinCodeInput: '',
      pinVerified: false,
      init: async function() {
        var response = await fetch(`${baseUrl}/amazon/token`)
        var data = await response.json()

        device = new Twilio.Device(data.token, {
          closeProtection: true,
          codecPreferences:	['opus', 'pcmu'],
          enableRingingState: true
        })

        device.on('ready', (device) => this.device = device)
        device.on('connect', () => this.setStep(3))
      },
      setStep: function(step){
        this.step = Math.max(this.step, step)
        setTimeout(() => this.$scroll(`#step${step}`, {offset: document.getElementById('volume-nav').offsetHeight}), 20)
      },
      call: function() {
        this.pinCode = Math.floor(Math.random() * 10000).toString().padStart(4, '0')
        this.connection = this.device.connect({AmazonPinCode: this.pinCode})
        this.connection.on('volume', (inputVolume, outputVolume) => {
          this.inputVolume = inputVolume
          this.outputVolume = outputVolume
        })
      },
      hangUp: function() {
        this.connection.disconnect()
        this.connection = null
        this.inputVolume = this.outputVolume = 0
      },
      verifyPinCode: async function() {
        if (this.pinCodeInput.trim() === this.pinCode) {
          this.pinVerified = true
          var callSid = this.connection.parameters.CallSid
          if (callSid) {
            var response = await fetch(`${baseUrl}amazon/update-sid/${callSid}`, {method: 'POST'})
            var data = await response.json()
            if (data.success) {
              this.setStep(5)
            } else {
              alert('An error occurred. Refresh the page and try again. (Error updating call.)')
            }
          } else {
            alert('An error occurred. Refresh the page and try again. (No call found.)')
          }
        } else {
          alert('Incorrect PIN code. Try again.')
        }
      }
    }
  }

  /*$(function() {

    var $callButton = $('#call-button')

    $.get(baseUrl + 'token', function(data) {
      Twilio.Device.setup(data.token, {
        closeProtection: true,
        codecPreferences:	['opus', 'pcmu']
      })
    })



    Twilio.Device.on('ready', function (device) {
      $callButton.prop('disabled', false).toggleClass('error primary')
      .html('\u{1F4DE}\u{1F4DE}&nbsp;&nbsp;&nbsp;&nbsp;Initiate Call&nbsp;&nbsp;&nbsp;&nbsp;\u{1F4DE}\u{1F4DE}').click(function(e) {
        e.preventDefault()

        device.connect({
          'AmazonPasscode':
        })
      })

    })

  })*/

</script>
